<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script src="//maps.googleapis.com/maps/api/js?sensor=false" type="text/javascript"></script>
<script src="http://scripts.embed.ly/jquery.embedly.min.js" type="text/javascript"></script>

<script type="text/javascript">

var tweet_set;
var tweet_check;

function search_twitter(q, page){
	q += " instagr filter:links";
	$.ajax({
	    url : "http://search.twitter.com/search.json?q="+escape(q)+"&page="+page+"&rpp=100&callback=?",
    	dataType: "json",
			success : function(data){
    		var urls = new Array();
    		var tweets = new Array();
        if (!data.results) return false;
        
	      //get the image url and status
    		for (i=0;i<data.results.length;i++){
    			var obj = data.results[i];    			
    			if (obj['geo'] == null) continue;
    			var p = obj.text.match(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig);

    			if (p != null){
    				var u = p[0].replace(' ', '');
    				var idx = urls.length;
    				urls[idx] = u;
    				tweets[idx] = obj;
    			}
    		}
	
        //call embedly and build display
				var counter = 0;
				$.embedly(urls, {maxWidth:500, key : '4eff5eecc9d811e083104040d3dc5c07' },
					function(oembed){					
						if (oembed != null && oembed.type == "photo"){
							build_display(oembed, tweets[counter]);
						}
						counter++;
				});
    	}
  });
}

function build_display(oembed, status){
	tweet = [
	  String(status['geo']['coordinates'][0]),
	  String(status['geo']['coordinates'][1]),
	  oembed['url'],
	  status['text']
	];
	
	if($.inArray(status['text'], tweet_check) == -1){
	  tweet_set.push(tweet);
	  tweet_check.push(status['text'])
	}
}

var panorama;

function initialize() {
  latlng = new google.maps.LatLng(40.709385,-74.011323);
  var panoramaOptions = {
    position: latlng,
    pov: {
      heading: 34,
      pitch: 10,
      zoom: 1
    },
    panControl: false,
    linksControl: false,
    zoomControl: false,
    addressControl: false,
    scrollwheel: false,
  };
  panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"), panoramaOptions);
}

var setPanorama = function(lat, lng){
  latlng = new google.maps.LatLng((lat), (lng)) 
  panorama.setPosition(latlng)
}

var timer;
var loop = function(index){
  (index == tweet_set.length - 1) ? index = 0 : index++;
  setPanorama(tweet_set[index][0], tweet_set[index][1])
  $("#overlay").attr("src", tweet_set[index][2]);
  $("#tweet").html(tweet_set[index][3]);
  timer = setTimeout(function(){loop(index)}, 3000);  
}

var countdown = function(timeLeft){
  tick = timeLeft / 1000 + "..";
  $("#countdown").html(tick)
  if (timeLeft - 1000 > 0){
    setTimeout(function(){countdown(timeLeft - 1000)}, 1000);  
  }
}

var scrape = function(){
  q = $("#queryInput").val();
  $("#queryDisplay").html(q);
  clearTimeout(timer);
  tweet_set = new Array()
  tweet_check = []
  for (i = 0; i < 15; i++){
    search_twitter(q, i);
  }
  
  countdown(5000);
  setTimeout(function(){loop(0)}, 5000);  
}

</script>
</head>
<body onload="initialize()">
  <input id="queryInput" type="text"></input>
  <input type="submit" onclick="scrape()"></input>
  <div id="queryDisplay"></div>
  <div id="countdown"></div>
  <div id="pano" style="width: 1200px; height: 600px;"></div>
  <img id="overlay" src=""/>
  <div id="tweet"></div>
</body>
</html>


