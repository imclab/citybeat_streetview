<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js" type="text/javascript"></script>
<script src="//maps.googleapis.com/maps/api/js?sensor=false" type="text/javascript"></script>
<script src="http://scripts.embed.ly/jquery.embedly.min.js" type="text/javascript"></script>
<link href='http://fonts.googleapis.com/css?family=Arvo:400,700' rel='stylesheet' type='text/css'>

<script type="text/javascript">

var tweet_set;
var tweet_check;
var tweet;
var oembeds;
var raw_tweets;
var current;

function search_twitter(q, page){
  q += " instagr filter:links";
  
	$.ajax({
	    url : "http://search.twitter.com/search.json?q="+escape(q)+"&page="+page+"&rpp=100&callback=?",
    	dataType: "json",
    	async: "false",
			success : function(data){
    		var urls = [];
    		var tweets = [];
        if (!data.results) return false;
        
	      //get the image url and status
    		for (i=0;i<data.results.length;i++){
    			var obj = data.results[i];    			
    			if (obj['geo'] == null) continue;
    			var p = obj.text.match(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig);

    			if (p != null){
    				var u = p[0].replace(' ', '');
    				var idx = urls.length;
    				urls[idx] = u;
    				tweets[idx] = obj;
    			}
    		}
	
        //call embedly and build display
				var counter = 0;
				$.embedly(urls, {maxWidth:500, key : '4eff5eecc9d811e083104040d3dc5c07' },
					function(oembed){					
						if (oembed != null && oembed.type == "photo"){
						  oembeds.push(oembed);
						  raw_tweets.push(tweets[counter]);
						}
						counter++;
				});
    	}
  });
}

var finishBuild = function(data, status){
  if (status == google.maps.StreetViewStatus.OK){
    if($.inArray(tweet[2], tweet_check) == -1){
      console.log(tweet)
      tweet[0] = data.location.latLng;
      tweet_set.push(tweet);
      tweet_check.push(tweet[2])
    }
  }
  if (current < oembeds.length - 1){
    current++;
    build_display(oembeds[current], raw_tweets[current])
  }
}

var sv = new google.maps.StreetViewService();
function build_display(oembed, status){
  lat = String(status['geo']['coordinates'][0]);
  lng = String(status['geo']['coordinates'][1]);
  latlng = new google.maps.LatLng((lat), (lng));
  tweet = [
    latlng,
    oembed['url'],
    status['text']
  ];
  sv.getPanoramaByLocation(latlng, 50, finishBuild);
}

var panorama;
function initialize() {
  latlng = new google.maps.LatLng(40.709385,-74.011323);
  var panoramaOptions = {
    position: latlng,
    pov: {
      heading: 34,
      pitch: 10,
      zoom: 1
    },
    panControl: false,
    linksControl: false,
    zoomControl: false,
    addressControl: false,
    scrollwheel: false,
  };
  panorama = new google.maps.StreetViewPanorama(document.getElementById("pano"), panoramaOptions);
}

var index = 0;
var setPanorama = function(latlng){
  panorama.setPosition(latlng);
  $("#overlay").attr("src", tweet_set[index][1]);
  $("#tweet").html(tweet_set[index][2]);
}

var timer;
var show_seconds = 10000;
//TODO: add error check for no results

var loop = function(){
  //free up memory - doubt it'll work
  oembeds = [];
  raw_tweets = [];
  
  (index == tweet_set.length - 1) ? index = 0 : index++;
  setPanorama(tweet_set[index][0])
  setTimeout(function(){
    $('#curtain').fadeOut('fast');
  }, 500);
  setTimeout(function(){
    $('#curtain').fadeIn('fast');
  }, show_seconds - 500);
  timer = setTimeout(function(){loop()}, show_seconds / 2);
}

var countdown = function(timeLeft){
  tick = timeLeft / 1000 + "...";
  $("#countdown").html(tick)
  if (timeLeft - 1000 > 0){
    setTimeout(function(){countdown(timeLeft - 1000)}, 1000);  
  } else{
    $("#countdown").html("")
  }
}

var scrape = function(){
  tweet_set = [];
  tweet_check = [];
  oembeds = [];
  raw_tweets = [];
  current = 0;
  index = 0;
  
  q = $("#queryInput").val();
  $("#queryDisplay").html(q);

  for(page = 0; page < 15; page++){
    search_twitter(q, page);
  }

  setTimeout(function(){
    if(oembeds.length > 0){
      build_display(oembeds[0], raw_tweets[0]);  
    }
  }, (show_seconds / 2));
  
  
  countdown(show_seconds);
  setTimeout(function(){loop()}, show_seconds);  
  setTimeout(function(){
    $('#change_modal').fadeOut(500);
  }, show_seconds);  
}

$(".toggleModal").live("click", function() {
  clearTimeout(timer);
  $("#change_modal").fadeToggle(500, "linear"); 
});

</script>
<style type="text/css">
  * {
    margin: 0px;
    padding: 0px;
  }
  html, body {
    height: 100%;
    font-family: "Arvo", "Helvetica", "Georgia", serif;
    font-size: 12px;
    vertical-align: baseline;
  }
  h1,h2,h3,h4,h5,h6 {
    line-height: 1.1em;
    margin-bottom: 12px;
  }
  p, ul, ol {
    line-height: 1.5em;
    margin-bottom: 12px;
  }
  a, a:visited {
    color: #aaa;
  }
  a:hover {
    text-decoration: none;
  }

  .left_right {
    width: 100%; 
    display: table;
    .left, .right {
      float: none;
      vertical-align: middle;
      display: table-cell;
    }
  }
  .left {
    width:100%;
  }
  .right {
    overflow: visible;
    white-space: nowrap;
    text-align: right;
  }

  #tweet, #overlay, #header {
    position: absolute;
    z-index: 4;
  }
  #tweet {
    margin-top: 10px;
    background-color: #ccc;
    padding: 18px 0px;
    filter: alpha(opacity=70);
    -khtml-opacity: 0.8;
    -moz-opacity: 0.8;
    opacity: 0.8; 
    border-top: 1px solid #444;
    font-size: 18px;
    text-align: center;
    position: absolute;
    bottom: 0px;
    width: 100%;
  }
  #header {
    top: 0px;
    width: 100%;
    line-height: 1.5em;
    background-color: #111;
    border-bottom: 1px solid #000;
    color: #7f7f7f;
  }
  #logo {
    margin: 12px;
    font-size: 18px;
    font-weight: bold;
    color: #efefef;
    display: inline-block;
    margin-right: 24px;
  }
  #queryDisplay {
    margin: 6px;
    display: inline-block;
  }
  #overlay {
    bottom: 78px;
    left: 18px;
    width: 400px;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
  }
  #curtain {
    position: fixed;
    width: 100%;
    height: 100%;
    background-color: #111;
    z-index: 3;
    background-image: url('images/triangles.png');
    display: none;
  }
  #change_modal {
    width: 476px;
    padding: 12px;
    position: absolute;
    left: 50%;
    top: 200px;
    margin-left: -250px;
    background-color: #efefef;
    border: 1px solid #000;
    -moz-border-radius: 5px;
    -webkit-border-radius: 5px;
    border-radius: 5px;
    z-index: 5;
  }
  input {
    padding: 6px;
  }
  .toggleModal {
    font-size: 12px;
  }
  #countdown_text {
    text-align: center;
    font-style: italic;
  }
  #countdown {
    font-style: normal;
    font-weight: bold;
    margin-left: 6px;
    font-size: 24px;
    text-align: center;
    line-height: 2em;
  }
</style>
</head>
<body onload="initialize()">
  <div id="header">
    <span id="logo">citybeat</span>
    <span id="queryText">Searching For:</span>
    <span id="queryDisplay">Nothing Yet</span>
    <a href="#" class="toggleModal">Change Search Term</a>
  </div>
  <div id="curtain"></div>
  <div id="pano" style="width: 100%; height: 100%;"></div>
  <img id="overlay"/>
  <div id="tweet"></div>
  <div id="change_modal">
    <h1>HEY THERE!</h1>
    <p>Search for a word in the bar below and see realtime photos, tweets, and location!</p>
      <input id="queryInput" type="text" value="christmas" />
      <input type="submit" onclick="scrape()" value="Entertain Me" />
    <div id="countdown"></div>
  </div>
</body>
</html>


